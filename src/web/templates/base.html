<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}è€ƒå¤é¡Œè™•ç†ç³»çµ±{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    {% block extra_css %}{% endblock %}
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-brand">
                <h1>ğŸ“š è€ƒå¤é¡Œè™•ç†ç³»çµ±</h1>
            </div>
            <ul class="navbar-menu">
                <li><a href="{{ url_for('index') }}">é¦–é </a></li>
                <li><a href="{{ url_for('crawler_page') }}">çˆ¬èŸ²ä¸‹è¼‰</a></li>
                <li><a href="{{ url_for('ocr_page') }}">OCRè™•ç†</a></li>
                <li><a href="{{ url_for('upload_page') }}">PDFè™•ç†</a></li>
                <li><a href="{{ url_for('monitor_page') }}">æ€§èƒ½ç›£æ§</a></li>
            </ul>
        </div>
    </nav>

    <main class="main-content">
        <div class="container">
            {% block content %}{% endblock %}
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 è€ƒå¤é¡Œè™•ç†ç³»çµ± v2.0.0 |
            <a href="https://github.com/yourusername/exam-processor" target="_blank">GitHub</a>
            </p>
        </div>
    </footer>

    <script>
        // CSRF ä¿è­·å·¥å…·
        let csrfToken = null;

        // ç²å– CSRF Token
        async function getCsrfToken() {
            if (csrfToken) return csrfToken;

            try {
                const response = await fetch('/api/csrf-token');
                const data = await response.json();
                csrfToken = data.csrf_token;
                return csrfToken;
            } catch (error) {
                console.error('ç²å– CSRF Token å¤±æ•—:', error);
                return null;
            }
        }

        // å¸¶ CSRF ä¿è­·çš„ fetch å°è£
        async function secureFetch(url, options = {}) {
            const token = await getCsrfToken();

            // åˆä½µé¸é …
            const mergedOptions = { ...options };

            // åˆå§‹åŒ– headersï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            if (!mergedOptions.headers) {
                mergedOptions.headers = {};
            }

            // å¦‚æœæ²’æœ‰ body æ˜¯ FormDataï¼Œè¨­ç½®é»˜èª Content-Type
            // FormData æœƒè‡ªå‹•è¨­ç½®æ­£ç¢ºçš„ Content-Typeï¼ˆåŒ…å« boundaryï¼‰
            if (!(options.body instanceof FormData)) {
                if (!mergedOptions.headers['Content-Type'] && !mergedOptions.headers['content-type']) {
                    mergedOptions.headers['Content-Type'] = 'application/json';
                }
            }

            // ç‚º POST/PUT/DELETE è«‹æ±‚æ·»åŠ  CSRF Token
            if (token && ['POST', 'PUT', 'DELETE', 'PATCH'].includes((options.method || 'GET').toUpperCase())) {
                mergedOptions.headers['X-CSRFToken'] = token;
            }

            return fetch(url, mergedOptions);
        }

        // é é¢åŠ è¼‰æ™‚é å…ˆç²å– CSRF Token
        document.addEventListener('DOMContentLoaded', () => {
            getCsrfToken();
        });
    </script>
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    {% block extra_js %}{% endblock %}
</body>
</html>
