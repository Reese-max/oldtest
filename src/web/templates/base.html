<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}è€ƒå¤é¡Œè™•ç†ç³»çµ±{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    {% block extra_css %}{% endblock %}
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-brand">
                <h1>ğŸ“š è€ƒå¤é¡Œè™•ç†ç³»çµ±</h1>
            </div>
            <ul class="navbar-menu">
                <li><a href="{{ url_for('index') }}">é¦–é </a></li>
                <li><a href="{{ url_for('crawler_page') }}">çˆ¬èŸ²ä¸‹è¼‰</a></li>
                <li><a href="{{ url_for('ocr_page') }}">OCRè™•ç†</a></li>
                <li><a href="{{ url_for('upload_page') }}">PDFè™•ç†</a></li>
                <li><a href="{{ url_for('monitor_page') }}">æ€§èƒ½ç›£æ§</a></li>
            </ul>
        </div>
    </nav>

    <main class="main-content">
        <div class="container">
            {% block content %}{% endblock %}
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 è€ƒå¤é¡Œè™•ç†ç³»çµ± v2.0.0 |
            <a href="https://github.com/yourusername/exam-processor" target="_blank">GitHub</a>
            </p>
        </div>
    </footer>

    <script>
        // ==================== å‰ç«¯éŒ¯èª¤é‚Šç•Œ ====================

        // å…¨å±€éŒ¯èª¤è™•ç†å™¨
        window.addEventListener('error', function(event) {
            console.error('Global error caught:', event.error);

            // é¡¯ç¤ºå‹å¥½çš„éŒ¯èª¤è¨Šæ¯çµ¦ç”¨æˆ¶
            showErrorNotification(
                'ç™¼ç”Ÿæœªé æœŸçš„éŒ¯èª¤',
                'æŠ±æ­‰ï¼Œé é¢é‹è¡Œæ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚è«‹åˆ·æ–°é é¢å¾Œé‡è©¦ã€‚'
            );

            // å¯é¸ï¼šç™¼é€éŒ¯èª¤å ±å‘Šåˆ°æœå‹™å™¨
            reportErrorToServer({
                message: event.error?.message || 'æœªçŸ¥éŒ¯èª¤',
                stack: event.error?.stack || '',
                url: event.filename || window.location.href,
                line: event.lineno,
                column: event.colno,
                timestamp: new Date().toISOString()
            });

            // é˜»æ­¢é»˜èªçš„éŒ¯èª¤è™•ç†
            event.preventDefault();
        });

        // æ•ç²æœªè™•ç†çš„ Promise æ‹’çµ•
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);

            // é¡¯ç¤ºå‹å¥½çš„éŒ¯èª¤è¨Šæ¯
            showErrorNotification(
                'Promise éŒ¯èª¤',
                'ç•°æ­¥æ“ä½œå¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦ã€‚'
            );

            // å ±å‘ŠéŒ¯èª¤
            reportErrorToServer({
                message: event.reason?.message || String(event.reason),
                stack: event.reason?.stack || '',
                type: 'unhandledrejection',
                timestamp: new Date().toISOString()
            });

            // é˜»æ­¢é»˜èªè™•ç†
            event.preventDefault();
        });

        // é¡¯ç¤ºéŒ¯èª¤é€šçŸ¥
        function showErrorNotification(title, message) {
            // å¦‚æœé é¢æœ‰ Toast é€šçŸ¥ç³»çµ±ï¼Œä½¿ç”¨å®ƒ
            if (typeof showToast === 'function') {
                showToast(title + ': ' + message, 'error');
                return;
            }

            // å¦å‰‡ä½¿ç”¨ç°¡å–®çš„ alertï¼ˆå¾ŒçºŒæœƒè¢« Toast ç³»çµ±æ›¿æ›ï¼‰
            console.warn('Error notification:', title, message);

            // å‰µå»ºç°¡å–®çš„éŒ¯èª¤æç¤º
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #f44336;
                color: white;
                padding: 16px 20px;
                border-radius: 4px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                z-index: 10000;
                max-width: 400px;
                animation: slideIn 0.3s ease-out;
            `;
            errorDiv.innerHTML = `
                <strong>${title}</strong><br>
                <span style="font-size: 0.9em;">${message}</span>
            `;
            document.body.appendChild(errorDiv);

            // 3ç§’å¾Œè‡ªå‹•ç§»é™¤
            setTimeout(() => {
                errorDiv.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => errorDiv.remove(), 300);
            }, 5000);
        }

        // å‘æœå‹™å™¨å ±å‘ŠéŒ¯èª¤ï¼ˆå¯é¸ï¼‰
        function reportErrorToServer(errorInfo) {
            // åƒ…åœ¨ç”Ÿç”¢ç’°å¢ƒæˆ–é…ç½®å•Ÿç”¨æ™‚ç™¼é€
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                // é–‹ç™¼ç’°å¢ƒåªè¨˜éŒ„åˆ°æ§åˆ¶å°
                console.log('Error report (dev):', errorInfo);
                return;
            }

            // å¯ä»¥å¯¦ç¾ç™¼é€éŒ¯èª¤åˆ°æœå‹™å™¨çš„é‚è¼¯
            // fetch('/api/error-report', {
            //     method: 'POST',
            //     headers: {'Content-Type': 'application/json'},
            //     body: JSON.stringify(errorInfo)
            // }).catch(err => console.error('Failed to report error:', err));
        }

        // ==================== CSRF ä¿è­·å·¥å…· ====================

        // CSRF ä¿è­·å·¥å…·
        let csrfToken = null;

        // ç²å– CSRF Token
        async function getCsrfToken() {
            if (csrfToken) return csrfToken;

            try {
                const response = await fetch('/api/csrf-token');
                const data = await response.json();
                csrfToken = data.csrf_token;
                return csrfToken;
            } catch (error) {
                console.error('ç²å– CSRF Token å¤±æ•—:', error);
                return null;
            }
        }

        // å¸¶ CSRF ä¿è­·çš„ fetch å°è£
        async function secureFetch(url, options = {}) {
            const token = await getCsrfToken();

            // åˆä½µé¸é …
            const mergedOptions = { ...options };

            // åˆå§‹åŒ– headersï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            if (!mergedOptions.headers) {
                mergedOptions.headers = {};
            }

            // å¦‚æœæ²’æœ‰ body æ˜¯ FormDataï¼Œè¨­ç½®é»˜èª Content-Type
            // FormData æœƒè‡ªå‹•è¨­ç½®æ­£ç¢ºçš„ Content-Typeï¼ˆåŒ…å« boundaryï¼‰
            if (!(options.body instanceof FormData)) {
                if (!mergedOptions.headers['Content-Type'] && !mergedOptions.headers['content-type']) {
                    mergedOptions.headers['Content-Type'] = 'application/json';
                }
            }

            // ç‚º POST/PUT/DELETE è«‹æ±‚æ·»åŠ  CSRF Token
            if (token && ['POST', 'PUT', 'DELETE', 'PATCH'].includes((options.method || 'GET').toUpperCase())) {
                mergedOptions.headers['X-CSRFToken'] = token;
            }

            return fetch(url, mergedOptions);
        }

        // é é¢åŠ è¼‰æ™‚é å…ˆç²å– CSRF Token
        document.addEventListener('DOMContentLoaded', () => {
            getCsrfToken();
        });
    </script>
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    {% block extra_js %}{% endblock %}
</body>
</html>
