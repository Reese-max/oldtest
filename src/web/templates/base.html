<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}è€ƒå¤é¡Œè™•ç†ç³»çµ±{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    {% block extra_css %}{% endblock %}

    <style>
        /* Toast é€šçŸ¥ç³»çµ±æ¨£å¼ */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }

        .toast {
            min-width: 300px;
            max-width: 400px;
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            pointer-events: auto;
            animation: slideInRight 0.3s ease-out;
            background: white;
            border-left: 4px solid;
            cursor: pointer;
            transition: all 0.3s;
        }

        .toast:hover {
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
            transform: translateX(-4px);
        }

        .toast.toast-success {
            border-left-color: #4CAF50;
        }

        .toast.toast-error {
            border-left-color: #f44336;
        }

        .toast.toast-warning {
            border-left-color: #ff9800;
        }

        .toast.toast-info {
            border-left-color: #2196F3;
        }

        .toast-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .toast-success .toast-icon { color: #4CAF50; }
        .toast-error .toast-icon { color: #f44336; }
        .toast-warning .toast-icon { color: #ff9800; }
        .toast-info .toast-icon { color: #2196F3; }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: #333;
        }

        .toast-message {
            font-size: 0.9em;
            color: #666;
            line-height: 1.4;
        }

        .toast-close {
            font-size: 20px;
            color: #999;
            cursor: pointer;
            flex-shrink: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s;
        }

        .toast-close:hover {
            color: #333;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        .toast.toast-exit {
            animation: slideOutRight 0.3s ease-out forwards;
        }

        /* é€²åº¦æ¢ */
        .toast-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: currentColor;
            opacity: 0.3;
            width: 100%;
            transform-origin: left;
        }

        .toast-success .toast-progress { background: #4CAF50; }
        .toast-error .toast-progress { background: #f44336; }
        .toast-warning .toast-progress { background: #ff9800; }
        .toast-info .toast-progress { background: #2196F3; }

        /* å…¨å±€åŠ è¼‰æŒ‡ç¤ºå™¨ */
        #global-loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        #global-loading.active {
            display: flex;
        }

        .loading-content {
            background: white;
            padding: 30px 40px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #333;
            font-size: 16px;
            font-weight: 500;
        }

        /* ç¢ºèªå°è©±æ¡† */
        #confirm-dialog {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9998;
            justify-content: center;
            align-items: center;
        }

        #confirm-dialog.active {
            display: flex;
        }

        .confirm-content {
            background: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            min-width: 400px;
            max-width: 500px;
            animation: fadeInScale 0.2s ease-out;
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .confirm-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .confirm-icon {
            font-size: 24px;
        }

        .confirm-message {
            color: #666;
            margin-bottom: 24px;
            line-height: 1.5;
        }

        .confirm-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .confirm-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .confirm-btn-cancel {
            background: #f5f5f5;
            color: #666;
        }

        .confirm-btn-cancel:hover {
            background: #e0e0e0;
        }

        .confirm-btn-confirm {
            background: #4CAF50;
            color: white;
        }

        .confirm-btn-confirm:hover {
            background: #45a049;
        }

        .confirm-btn-confirm.danger {
            background: #f44336;
        }

        .confirm-btn-confirm.danger:hover {
            background: #da190b;
        }
    </style>
</head>
<body>
    <!-- Toast é€šçŸ¥å®¹å™¨ -->
    <div id="toast-container"></div>

    <!-- å…¨å±€åŠ è¼‰æŒ‡ç¤ºå™¨ -->
    <div id="global-loading">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">è™•ç†ä¸­ï¼Œè«‹ç¨å€™...</div>
        </div>
    </div>

    <!-- ç¢ºèªå°è©±æ¡† -->
    <div id="confirm-dialog">
        <div class="confirm-content">
            <div class="confirm-title">
                <span class="confirm-icon">âš </span>
                <span id="confirm-title-text">ç¢ºèªæ“ä½œ</span>
            </div>
            <div class="confirm-message" id="confirm-message-text"></div>
            <div class="confirm-buttons">
                <button class="confirm-btn confirm-btn-cancel" id="confirm-cancel-btn">å–æ¶ˆ</button>
                <button class="confirm-btn confirm-btn-confirm" id="confirm-confirm-btn">ç¢ºèª</button>
            </div>
        </div>
    </div>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-brand">
                <h1>ğŸ“š è€ƒå¤é¡Œè™•ç†ç³»çµ±</h1>
            </div>
            <ul class="navbar-menu">
                <li><a href="{{ url_for('index') }}">é¦–é </a></li>
                <li><a href="{{ url_for('crawler_page') }}">çˆ¬èŸ²ä¸‹è¼‰</a></li>
                <li><a href="{{ url_for('ocr_page') }}">OCRè™•ç†</a></li>
                <li><a href="{{ url_for('upload_page') }}">PDFè™•ç†</a></li>
                <li><a href="{{ url_for('monitor_page') }}">æ€§èƒ½ç›£æ§</a></li>
            </ul>
        </div>
    </nav>

    <main class="main-content">
        <div class="container">
            {% block content %}{% endblock %}
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 è€ƒå¤é¡Œè™•ç†ç³»çµ± v2.0.0 |
            <a href="https://github.com/yourusername/exam-processor" target="_blank">GitHub</a>
            </p>
        </div>
    </footer>

    <script>
        // ==================== Toast é€šçŸ¥ç³»çµ± ====================

        const toastIcons = {
            success: 'âœ“',
            error: 'âœ—',
            warning: 'âš ',
            info: 'â„¹'
        };

        const toastTitles = {
            success: 'æˆåŠŸ',
            error: 'éŒ¯èª¤',
            warning: 'è­¦å‘Š',
            info: 'æç¤º'
        };

        /**
         * é¡¯ç¤º Toast é€šçŸ¥
         * @param {string} message - é€šçŸ¥è¨Šæ¯
         * @param {string} type - é€šçŸ¥é¡å‹: success, error, warning, info
         * @param {number} duration - é¡¯ç¤ºæ™‚é•·ï¼ˆæ¯«ç§’ï¼‰ï¼Œ0 è¡¨ç¤ºä¸è‡ªå‹•é—œé–‰
         * @param {string} title - è‡ªå®šç¾©æ¨™é¡Œï¼ˆå¯é¸ï¼‰
         */
        function showToast(message, type = 'info', duration = 4000, title = null) {
            const container = document.getElementById('toast-container');
            if (!container) {
                console.error('Toast container not found');
                return;
            }

            // å‰µå»º toast å…ƒç´ 
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.style.position = 'relative';

            // ä½¿ç”¨æä¾›çš„æ¨™é¡Œæˆ–é»˜èªæ¨™é¡Œ
            const toastTitle = title || toastTitles[type] || 'é€šçŸ¥';

            toast.innerHTML = `
                <div class="toast-icon">${toastIcons[type] || 'â„¹'}</div>
                <div class="toast-content">
                    <div class="toast-title">${toastTitle}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <div class="toast-close">Ã—</div>
                ${duration > 0 ? '<div class="toast-progress"></div>' : ''}
            `;

            // æ·»åŠ åˆ°å®¹å™¨
            container.appendChild(toast);

            // é—œé–‰æŒ‰éˆ•äº‹ä»¶
            const closeBtn = toast.querySelector('.toast-close');
            closeBtn.addEventListener('click', () => closeToast(toast));

            // é»æ“Š toast ä¹Ÿå¯ä»¥é—œé–‰
            toast.addEventListener('click', (e) => {
                if (e.target !== closeBtn && !e.target.closest('.toast-close')) {
                    closeToast(toast);
                }
            });

            // è‡ªå‹•é—œé–‰
            if (duration > 0) {
                const progressBar = toast.querySelector('.toast-progress');
                if (progressBar) {
                    // è¨­ç½®é€²åº¦æ¢å‹•ç•«
                    progressBar.style.transition = `transform ${duration}ms linear`;
                    setTimeout(() => {
                        progressBar.style.transform = 'scaleX(0)';
                    }, 10);
                }

                setTimeout(() => {
                    closeToast(toast);
                }, duration);
            }

            // é™åˆ¶ toast æ•¸é‡ï¼ˆæœ€å¤š 5 å€‹ï¼‰
            const toasts = container.querySelectorAll('.toast');
            if (toasts.length > 5) {
                closeToast(toasts[0]);
            }

            return toast;
        }

        /**
         * é—œé–‰ Toast
         */
        function closeToast(toast) {
            if (!toast || toast.classList.contains('toast-exit')) return;

            toast.classList.add('toast-exit');
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 300);
        }

        /**
         * ä¾¿æ·æ–¹æ³•
         */
        window.toast = {
            success: (message, duration) => showToast(message, 'success', duration),
            error: (message, duration) => showToast(message, 'error', duration),
            warning: (message, duration) => showToast(message, 'warning', duration),
            info: (message, duration) => showToast(message, 'info', duration)
        };

        // ==================== å…¨å±€åŠ è¼‰æŒ‡ç¤ºå™¨ ====================

        let loadingElement = null;
        let loadingText = null;

        /**
         * é¡¯ç¤ºå…¨å±€åŠ è¼‰æŒ‡ç¤ºå™¨
         * @param {string} message - åŠ è¼‰æç¤ºè¨Šæ¯
         */
        function showLoading(message = 'è™•ç†ä¸­ï¼Œè«‹ç¨å€™...') {
            if (!loadingElement) {
                loadingElement = document.getElementById('global-loading');
                loadingText = loadingElement?.querySelector('.loading-text');
            }

            if (loadingElement) {
                if (loadingText) {
                    loadingText.textContent = message;
                }
                loadingElement.classList.add('active');
            }
        }

        /**
         * éš±è—å…¨å±€åŠ è¼‰æŒ‡ç¤ºå™¨
         */
        function hideLoading() {
            if (loadingElement) {
                loadingElement.classList.remove('active');
            }
        }

        /**
         * å¸¶åŠ è¼‰æŒ‡ç¤ºå™¨çš„ç•°æ­¥æ“ä½œ
         * @param {Function} asyncFn - ç•°æ­¥å‡½æ•¸
         * @param {string} message - åŠ è¼‰æç¤ºè¨Šæ¯
         */
        async function withLoading(asyncFn, message) {
            showLoading(message);
            try {
                return await asyncFn();
            } finally {
                hideLoading();
            }
        }

        // ==================== ç¢ºèªå°è©±æ¡† ====================

        let confirmDialog = null;
        let confirmResolve = null;

        /**
         * é¡¯ç¤ºç¢ºèªå°è©±æ¡†ï¼ˆPromise ç‰ˆæœ¬ï¼Œæ›¿ä»£ window.confirmï¼‰
         * @param {string} message - ç¢ºèªè¨Šæ¯
         * @param {object} options - é¸é …
         * @returns {Promise<boolean>} - ç”¨æˆ¶é¸æ“‡çµæœ
         */
        function confirmDialog(message, options = {}) {
            return new Promise((resolve) => {
                const dialog = document.getElementById('confirm-dialog');
                if (!dialog) {
                    // é™ç´šåˆ°åŸç”Ÿ confirm
                    resolve(window.confirm(message));
                    return;
                }

                const titleText = dialog.querySelector('#confirm-title-text');
                const messageText = dialog.querySelector('#confirm-message-text');
                const confirmBtn = dialog.querySelector('#confirm-confirm-btn');
                const cancelBtn = dialog.querySelector('#confirm-cancel-btn');

                // è¨­ç½®å…§å®¹
                titleText.textContent = options.title || 'ç¢ºèªæ“ä½œ';
                messageText.textContent = message;

                // è¨­ç½®æŒ‰éˆ•æ¨£å¼
                confirmBtn.textContent = options.confirmText || 'ç¢ºèª';
                cancelBtn.textContent = options.cancelText || 'å–æ¶ˆ';

                if (options.danger) {
                    confirmBtn.classList.add('danger');
                } else {
                    confirmBtn.classList.remove('danger');
                }

                // é¡¯ç¤ºå°è©±æ¡†
                dialog.classList.add('active');

                // ç¢ºèªæŒ‰éˆ•
                const onConfirm = () => {
                    cleanup();
                    resolve(true);
                };

                // å–æ¶ˆæŒ‰éˆ•
                const onCancel = () => {
                    cleanup();
                    resolve(false);
                };

                // æ¸…ç†å‡½æ•¸
                const cleanup = () => {
                    dialog.classList.remove('active');
                    confirmBtn.removeEventListener('click', onConfirm);
                    cancelBtn.removeEventListener('click', onCancel);
                    dialog.removeEventListener('click', onBackdropClick);
                };

                // èƒŒæ™¯é»æ“Šé—œé–‰
                const onBackdropClick = (e) => {
                    if (e.target === dialog) {
                        onCancel();
                    }
                };

                // ç¶å®šäº‹ä»¶
                confirmBtn.addEventListener('click', onConfirm);
                cancelBtn.addEventListener('click', onCancel);
                dialog.addEventListener('click', onBackdropClick);

                // ESC éµé—œé–‰
                const onEscape = (e) => {
                    if (e.key === 'Escape') {
                        onCancel();
                        document.removeEventListener('keydown', onEscape);
                    }
                };
                document.addEventListener('keydown', onEscape);
            });
        }

        /**
         * ä¾¿æ·æ–¹æ³•ï¼šå±éšªæ“ä½œç¢ºèª
         */
        async function confirmDelete(itemName) {
            return await confirmDialog(
                `ç¢ºå®šè¦åˆªé™¤ã€Œ${itemName}ã€å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ã€‚`,
                {
                    title: 'ç¢ºèªåˆªé™¤',
                    confirmText: 'åˆªé™¤',
                    cancelText: 'å–æ¶ˆ',
                    danger: true
                }
            );
        }

        // ==================== å‰ç«¯éŒ¯èª¤é‚Šç•Œ ====================

        // å…¨å±€éŒ¯èª¤è™•ç†å™¨
        window.addEventListener('error', function(event) {
            console.error('Global error caught:', event.error);

            // é¡¯ç¤ºå‹å¥½çš„éŒ¯èª¤è¨Šæ¯çµ¦ç”¨æˆ¶
            showErrorNotification(
                'ç™¼ç”Ÿæœªé æœŸçš„éŒ¯èª¤',
                'æŠ±æ­‰ï¼Œé é¢é‹è¡Œæ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚è«‹åˆ·æ–°é é¢å¾Œé‡è©¦ã€‚'
            );

            // å¯é¸ï¼šç™¼é€éŒ¯èª¤å ±å‘Šåˆ°æœå‹™å™¨
            reportErrorToServer({
                message: event.error?.message || 'æœªçŸ¥éŒ¯èª¤',
                stack: event.error?.stack || '',
                url: event.filename || window.location.href,
                line: event.lineno,
                column: event.colno,
                timestamp: new Date().toISOString()
            });

            // é˜»æ­¢é»˜èªçš„éŒ¯èª¤è™•ç†
            event.preventDefault();
        });

        // æ•ç²æœªè™•ç†çš„ Promise æ‹’çµ•
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);

            // é¡¯ç¤ºå‹å¥½çš„éŒ¯èª¤è¨Šæ¯
            showErrorNotification(
                'Promise éŒ¯èª¤',
                'ç•°æ­¥æ“ä½œå¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦ã€‚'
            );

            // å ±å‘ŠéŒ¯èª¤
            reportErrorToServer({
                message: event.reason?.message || String(event.reason),
                stack: event.reason?.stack || '',
                type: 'unhandledrejection',
                timestamp: new Date().toISOString()
            });

            // é˜»æ­¢é»˜èªè™•ç†
            event.preventDefault();
        });

        // é¡¯ç¤ºéŒ¯èª¤é€šçŸ¥ï¼ˆä½¿ç”¨ Toast ç³»çµ±ï¼‰
        function showErrorNotification(title, message) {
            // ä½¿ç”¨ Toast ç³»çµ±é¡¯ç¤ºéŒ¯èª¤
            showToast(message, 'error', 6000, title);
        }

        // å‘æœå‹™å™¨å ±å‘ŠéŒ¯èª¤ï¼ˆå¯é¸ï¼‰
        function reportErrorToServer(errorInfo) {
            // åƒ…åœ¨ç”Ÿç”¢ç’°å¢ƒæˆ–é…ç½®å•Ÿç”¨æ™‚ç™¼é€
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                // é–‹ç™¼ç’°å¢ƒåªè¨˜éŒ„åˆ°æ§åˆ¶å°
                console.log('Error report (dev):', errorInfo);
                return;
            }

            // å¯ä»¥å¯¦ç¾ç™¼é€éŒ¯èª¤åˆ°æœå‹™å™¨çš„é‚è¼¯
            // fetch('/api/error-report', {
            //     method: 'POST',
            //     headers: {'Content-Type': 'application/json'},
            //     body: JSON.stringify(errorInfo)
            // }).catch(err => console.error('Failed to report error:', err));
        }

        // ==================== CSRF ä¿è­·å·¥å…· ====================

        // CSRF ä¿è­·å·¥å…·
        let csrfToken = null;

        // ç²å– CSRF Token
        async function getCsrfToken() {
            if (csrfToken) return csrfToken;

            try {
                const response = await fetch('/api/csrf-token');
                const data = await response.json();
                csrfToken = data.csrf_token;
                return csrfToken;
            } catch (error) {
                console.error('ç²å– CSRF Token å¤±æ•—:', error);
                return null;
            }
        }

        // å¸¶ CSRF ä¿è­·çš„ fetch å°è£
        async function secureFetch(url, options = {}) {
            const token = await getCsrfToken();

            // åˆä½µé¸é …
            const mergedOptions = { ...options };

            // åˆå§‹åŒ– headersï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            if (!mergedOptions.headers) {
                mergedOptions.headers = {};
            }

            // å¦‚æœæ²’æœ‰ body æ˜¯ FormDataï¼Œè¨­ç½®é»˜èª Content-Type
            // FormData æœƒè‡ªå‹•è¨­ç½®æ­£ç¢ºçš„ Content-Typeï¼ˆåŒ…å« boundaryï¼‰
            if (!(options.body instanceof FormData)) {
                if (!mergedOptions.headers['Content-Type'] && !mergedOptions.headers['content-type']) {
                    mergedOptions.headers['Content-Type'] = 'application/json';
                }
            }

            // ç‚º POST/PUT/DELETE è«‹æ±‚æ·»åŠ  CSRF Token
            if (token && ['POST', 'PUT', 'DELETE', 'PATCH'].includes((options.method || 'GET').toUpperCase())) {
                mergedOptions.headers['X-CSRFToken'] = token;
            }

            return fetch(url, mergedOptions);
        }

        // é é¢åŠ è¼‰æ™‚é å…ˆç²å– CSRF Token
        document.addEventListener('DOMContentLoaded', () => {
            getCsrfToken();
        });
    </script>
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    {% block extra_js %}{% endblock %}
</body>
</html>
