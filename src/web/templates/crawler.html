{% extends "base.html" %}

{% block title %}çˆ¬èŸ²ä¸‹è¼‰ - è€ƒå¤é¡Œè™•ç†ç³»çµ±{% endblock %}

{% block extra_css %}
<style>
.crawler-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.card {
    background: white;
    border-radius: 8px;
    padding: 24px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.card-title {
    font-size: 20px;
    font-weight: bold;
    margin-bottom: 20px;
    color: #333;
}

.form-group {
    margin-bottom: 20px;
}

.form-label {
    display: block;
    font-weight: 600;
    margin-bottom: 8px;
    color: #555;
}

.form-input {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

.checkbox-group {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 10px;
}

.checkbox-label {
    display: flex;
    align-items: center;
    padding: 8px;
    background: #f5f5f5;
    border-radius: 4px;
    cursor: pointer;
}

.checkbox-label:hover {
    background: #e8e8e8;
}

.checkbox-label input {
    margin-right: 8px;
}

.button {
    padding: 12px 24px;
    border: none;
    border-radius: 4px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
}

.button-primary {
    background: #4CAF50;
    color: white;
}

.button-primary:hover {
    background: #45a049;
}

.button-danger {
    background: #f44336;
    color: white;
}

.button-danger:hover {
    background: #da190b;
}

.button:disabled {
    background: #ccc;
    cursor: not-allowed;
}

.task-list {
    margin-top: 20px;
}

.task-item {
    background: #f9f9f9;
    border-left: 4px solid #4CAF50;
    padding: 16px;
    margin-bottom: 12px;
    border-radius: 4px;
}

.task-item.running {
    border-color: #2196F3;
    background: #e3f2fd;
}

.task-item.failed {
    border-color: #f44336;
    background: #ffebee;
}

.task-item.cancelled {
    border-color: #ff9800;
    background: #fff3e0;
}

.task-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}

.task-status {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
}

.task-status.pending { background: #e0e0e0; color: #666; }
.task-status.running { background: #2196F3; color: white; }
.task-status.completed { background: #4CAF50; color: white; }
.task-status.failed { background: #f44336; color: white; }
.task-status.cancelled { background: #ff9800; color: white; }

.task-progress {
    margin-top: 12px;
}

.progress-bar {
    height: 20px;
    background: #e0e0e0;
    border-radius: 10px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: #4CAF50;
    transition: width 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 12px;
    font-weight: 600;
}

.task-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 12px;
    margin-top: 12px;
}

.stat-item {
    background: white;
    padding: 8px;
    border-radius: 4px;
    text-align: center;
}

.stat-value {
    font-size: 24px;
    font-weight: bold;
    color: #4CAF50;
}

.stat-label {
    font-size: 12px;
    color: #666;
}

.task-logs {
    max-height: 200px;
    overflow-y: auto;
    background: #f5f5f5;
    padding: 12px;
    border-radius: 4px;
    font-family: monospace;
    font-size: 12px;
    margin-top: 12px;
}

.log-entry {
    margin-bottom: 4px;
    color: #333;
}

.quick-select {
    margin-top: 8px;
}

.quick-select button {
    padding: 6px 12px;
    margin-right: 8px;
    margin-bottom: 8px;
    background: #2196F3;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
}

.quick-select button:hover {
    background: #1976D2;
}

.alert {
    padding: 12px;
    border-radius: 4px;
    margin-bottom: 16px;
}

.alert-success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.alert-error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.alert-info {
    background: #d1ecf1;
    color: #0c5460;
    border: 1px solid #bee5eb;
}
</style>
{% endblock %}

{% block content %}
<div class="crawler-container">
    <h1 style="margin-bottom: 24px;">ğŸ•·ï¸ çˆ¬èŸ²ä¸‹è¼‰æ§åˆ¶å°</h1>

    <div id="alert-container"></div>

    <!-- é…ç½®å¡ç‰‡ -->
    <div class="card">
        <div class="card-title">ğŸ“‹ é…ç½®çˆ¬èŸ²ä»»å‹™</div>

        <div class="form-group">
            <label class="form-label">å¹´ä»½é¸æ“‡</label>
            <input type="text" id="year-input" class="form-input" placeholder="ä¾‹å¦‚: 113, 110-113, 110,112,113, all">
            <div class="quick-select">
                <button onclick="selectYears('latest')">æœ€è¿‘ä¸€å¹´</button>
                <button onclick="selectYears('recent3')">æœ€è¿‘ä¸‰å¹´</button>
                <button onclick="selectYears('recent5')">æœ€è¿‘äº”å¹´</button>
                <button onclick="selectYears('all')">å…¨éƒ¨å¹´ä»½</button>
            </div>
            <small style="color: #666; margin-top: 8px; display: block;">
                å¯ç”¨å¹´ä»½: <span id="available-years-text">è¼‰å…¥ä¸­...</span>
            </small>
        </div>

        <div class="form-group">
            <label class="form-label">è€ƒè©¦é¡å‹ <button onclick="selectAllKeywords()" style="font-size: 12px; margin-left: 8px;">å…¨é¸</button></label>
            <div class="checkbox-group" id="keywords-container">
                <!-- å‹•æ…‹å¡«å…… -->
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">ä¿å­˜ç›®éŒ„</label>
            <input type="text" id="save-dir" class="form-input" placeholder="ç•™ç©ºä½¿ç”¨é»˜èªç›®éŒ„">
        </div>

        <div style="display: flex; gap: 12px;">
            <button id="start-btn" class="button button-primary" onclick="startCrawler()">
                ğŸš€ é–‹å§‹ä¸‹è¼‰
            </button>
            <button id="refresh-btn" class="button" style="background: #2196F3; color: white;" onclick="refreshTasks()">
                ğŸ”„ åˆ·æ–°ä»»å‹™åˆ—è¡¨
            </button>
        </div>
    </div>

    <!-- ä»»å‹™åˆ—è¡¨ -->
    <div class="card">
        <div class="card-title">ğŸ“Š ä»»å‹™åˆ—è¡¨</div>
        <div id="task-list" class="task-list">
            <p style="color: #666; text-align: center;">æš«ç„¡ä»»å‹™</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let availableYears = [];
let defaultKeywords = [];
let currentTasks = {};
let refreshInterval = null;

// é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', () => {
    loadConfig();
    refreshTasks();

    // æ¯3ç§’è‡ªå‹•åˆ·æ–°ä»»å‹™åˆ—è¡¨
    refreshInterval = setInterval(refreshTasks, 3000);
});

// è¼‰å…¥é…ç½®
async function loadConfig() {
    try {
        const response = await fetch('/api/crawler/config');
        const data = await response.json();

        if (data.success) {
            availableYears = data.available_years;
            defaultKeywords = data.default_keywords;

            // æ›´æ–°å¯ç”¨å¹´ä»½é¡¯ç¤º
            document.getElementById('available-years-text').textContent =
                `æ°‘åœ‹ ${availableYears[0]} - ${availableYears[availableYears.length - 1]} å¹´`;

            // æ¸²æŸ“é—œéµå­—é¸é …
            renderKeywords();
        }
    } catch (error) {
        showAlert('è¼‰å…¥é…ç½®å¤±æ•—: ' + error.message, 'error');
    }
}

// æ¸²æŸ“é—œéµå­—é¸é …
function renderKeywords() {
    const container = document.getElementById('keywords-container');
    container.innerHTML = defaultKeywords.map(keyword => `
        <label class="checkbox-label">
            <input type="checkbox" class="keyword-checkbox" value="${keyword}" checked>
            <span>${keyword}</span>
        </label>
    `).join('');
}

// å¿«é€Ÿé¸æ“‡å¹´ä»½
function selectYears(type) {
    const input = document.getElementById('year-input');
    const latest = availableYears[availableYears.length - 1];

    switch(type) {
        case 'latest':
            input.value = latest.toString();
            break;
        case 'recent3':
            input.value = `${latest - 2}-${latest}`;
            break;
        case 'recent5':
            input.value = `${latest - 4}-${latest}`;
            break;
        case 'all':
            input.value = 'all';
            break;
    }
}

// å…¨é¸é—œéµå­—
function selectAllKeywords() {
    const checkboxes = document.querySelectorAll('.keyword-checkbox');
    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
    checkboxes.forEach(cb => cb.checked = !allChecked);
}

// è§£æå¹´ä»½è¼¸å…¥
function parseYears(input) {
    const trimmed = input.trim();

    if (!trimmed || trimmed.toLowerCase() === 'all' || trimmed === '*') {
        return availableYears;
    }

    if (trimmed.includes('-')) {
        const [start, end] = trimmed.split('-').map(s => parseInt(s.trim()));
        const years = [];
        for (let y = start; y <= end; y++) {
            if (availableYears.includes(y)) years.push(y);
        }
        return years;
    }

    if (trimmed.includes(',')) {
        return trimmed.split(',')
            .map(s => parseInt(s.trim()))
            .filter(y => availableYears.includes(y));
    }

    const year = parseInt(trimmed);
    return availableYears.includes(year) ? [year] : [];
}

// å•Ÿå‹•çˆ¬èŸ²
async function startCrawler() {
    const yearInput = document.getElementById('year-input').value;
    const saveDir = document.getElementById('save-dir').value;
    const checkboxes = document.querySelectorAll('.keyword-checkbox:checked');

    const years = parseYears(yearInput);
    const keywords = Array.from(checkboxes).map(cb => cb.value);

    if (years.length === 0) {
        showAlert('è«‹é¸æ“‡æœ‰æ•ˆçš„å¹´ä»½', 'error');
        return;
    }

    if (keywords.length === 0) {
        showAlert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹è€ƒè©¦é¡å‹', 'error');
        return;
    }

    const btn = document.getElementById('start-btn');
    btn.disabled = true;
    btn.textContent = 'â³ å•Ÿå‹•ä¸­...';

    try {
        const response = await fetch('/api/crawler/start', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ years, keywords, save_dir: saveDir || undefined })
        });

        const data = await response.json();

        if (data.success) {
            showAlert(`ä»»å‹™å·²å•Ÿå‹•ï¼ä»»å‹™ID: ${data.task_id}`, 'success');
            refreshTasks();
        } else {
            showAlert(data.error || 'å•Ÿå‹•å¤±æ•—', 'error');
        }
    } catch (error) {
        showAlert('å•Ÿå‹•å¤±æ•—: ' + error.message, 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = 'ğŸš€ é–‹å§‹ä¸‹è¼‰';
    }
}

// åˆ·æ–°ä»»å‹™åˆ—è¡¨
async function refreshTasks() {
    try {
        const response = await fetch('/api/crawler/tasks');
        const tasks = await response.json();

        currentTasks = {};
        tasks.forEach(task => {
            currentTasks[task.id] = task;
        });

        renderTasks(tasks);
    } catch (error) {
        console.error('åˆ·æ–°ä»»å‹™å¤±æ•—:', error);
    }
}

// æ¸²æŸ“ä»»å‹™åˆ—è¡¨
function renderTasks(tasks) {
    const container = document.getElementById('task-list');

    if (tasks.length === 0) {
        container.innerHTML = '<p style="color: #666; text-align: center;">æš«ç„¡ä»»å‹™</p>';
        return;
    }

    container.innerHTML = tasks.map(task => `
        <div class="task-item ${task.status}">
            <div class="task-header">
                <div>
                    <strong>ä»»å‹™ ID:</strong> ${task.id.substring(0, 8)}...
                    <span class="task-status ${task.status}">${getStatusText(task.status)}</span>
                </div>
                <div>
                    ${task.status === 'running' ?
                        `<button class="button button-danger" style="padding: 6px 12px; font-size: 12px;" onclick="stopTask('${task.id}')">â¹ï¸ åœæ­¢</button>` :
                        `<button class="button" style="padding: 6px 12px; font-size: 12px; background: #666; color: white;" onclick="deleteTask('${task.id}')">ğŸ—‘ï¸ åˆªé™¤</button>`
                    }
                </div>
            </div>

            <div>
                <strong>å¹´ä»½:</strong> ${task.years.join(', ')}
                <br>
                <strong>é—œéµå­—:</strong> ${task.keywords.join(', ')}
                <br>
                <strong>ä¿å­˜ç›®éŒ„:</strong> ${task.save_dir}
                <br>
                ${task.current_year ? `<strong>ç•¶å‰è™•ç†:</strong> æ°‘åœ‹ ${task.current_year} å¹´ - ${task.current_exam || ''}` : ''}
            </div>

            ${task.status === 'running' || task.status === 'completed' ? `
                <div class="task-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${task.progress}%">
                            ${task.progress}%
                        </div>
                    </div>
                </div>

                <div class="task-stats">
                    <div class="stat-item">
                        <div class="stat-value">${task.stats.success}</div>
                        <div class="stat-label">æˆåŠŸ</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${task.stats.failed}</div>
                        <div class="stat-label">å¤±æ•—</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${task.stats.completed_exams}</div>
                        <div class="stat-label">å®Œæˆè€ƒè©¦</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${(task.stats.total_size / 1024 / 1024).toFixed(2)} MB</div>
                        <div class="stat-label">ç¸½å¤§å°</div>
                    </div>
                </div>
            ` : ''}

            ${task.logs && task.logs.length > 0 ? `
                <div class="task-logs">
                    ${task.logs.slice(-10).map(log =>
                        `<div class="log-entry">[${new Date(log.timestamp).toLocaleTimeString()}] ${log.message}</div>`
                    ).join('')}
                </div>
            ` : ''}
        </div>
    `).join('');
}

// ç²å–ç‹€æ…‹æ–‡æœ¬
function getStatusText(status) {
    const statusMap = {
        'pending': 'ç­‰å¾…ä¸­',
        'running': 'é‹è¡Œä¸­',
        'completed': 'å·²å®Œæˆ',
        'failed': 'å¤±æ•—',
        'cancelled': 'å·²å–æ¶ˆ'
    };
    return statusMap[status] || status;
}

// åœæ­¢ä»»å‹™
async function stopTask(taskId) {
    if (!confirm('ç¢ºå®šè¦åœæ­¢æ­¤ä»»å‹™å—ï¼Ÿ')) return;

    try {
        const response = await fetch(`/api/crawler/stop/${taskId}`, {
            method: 'POST'
        });

        const data = await response.json();

        if (data.success) {
            showAlert('ä»»å‹™å·²åœæ­¢', 'success');
            refreshTasks();
        } else {
            showAlert(data.error || 'åœæ­¢å¤±æ•—', 'error');
        }
    } catch (error) {
        showAlert('åœæ­¢å¤±æ•—: ' + error.message, 'error');
    }
}

// åˆªé™¤ä»»å‹™
async function deleteTask(taskId) {
    if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ä»»å‹™å—ï¼Ÿ')) return;

    try {
        const response = await fetch(`/api/crawler/delete/${taskId}`, {
            method: 'DELETE'
        });

        const data = await response.json();

        if (data.success) {
            showAlert('ä»»å‹™å·²åˆªé™¤', 'success');
            refreshTasks();
        } else {
            showAlert(data.error || 'åˆªé™¤å¤±æ•—', 'error');
        }
    } catch (error) {
        showAlert('åˆªé™¤å¤±æ•—: ' + error.message, 'error');
    }
}

// é¡¯ç¤ºæç¤º
function showAlert(message, type = 'info') {
    const container = document.getElementById('alert-container');
    const alertClass = `alert-${type}`;

    const alert = document.createElement('div');
    alert.className = `alert ${alertClass}`;
    alert.textContent = message;

    container.appendChild(alert);

    setTimeout(() => {
        alert.remove();
    }, 5000);
}

// é é¢å¸è¼‰æ™‚æ¸…é™¤å®šæ™‚å™¨
window.addEventListener('beforeunload', () => {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
});
</script>
{% endblock %}
