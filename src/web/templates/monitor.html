{% extends "base.html" %}

{% block title %}æ€§èƒ½ç›£æ§ - è€ƒå¤é¡Œè™•ç†ç³»çµ±{% endblock %}

{% block content %}
<h1>â±ï¸ æ€§èƒ½ç›£æ§å„€è¡¨æ¿</h1>

<div class="monitor-summary">
    <div class="metric-card">
        <div class="metric-label">ç¸½è¨˜éŒ„æ•¸</div>
        <div class="metric-value" id="total-metrics">0</div>
    </div>
    <div class="metric-card">
        <div class="metric-label">ç¸½è€—æ™‚</div>
        <div class="metric-value" id="total-duration">0.00s</div>
    </div>
    <div class="metric-card">
        <div class="metric-label">å¹³å‡CPU</div>
        <div class="metric-value" id="avg-cpu">0.00%</div>
    </div>
    <div class="metric-card">
        <div class="metric-label">æˆåŠŸç‡</div>
        <div class="metric-value" id="success-rate">0.00%</div>
    </div>
</div>

<div class="monitor-sections">
    <div class="monitor-section">
        <h2>å‡½æ•¸çµ±è¨ˆ</h2>
        <div class="functions-table-container">
            <table class="functions-table" id="functionsTable">
                <thead>
                    <tr>
                        <th>å‡½æ•¸åç¨±</th>
                        <th>èª¿ç”¨æ¬¡æ•¸</th>
                        <th>ç¸½è€—æ™‚</th>
                        <th>å¹³å‡è€—æ™‚</th>
                        <th>æœ€å°è€—æ™‚</th>
                        <th>æœ€å¤§è€—æ™‚</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="6" class="no-data">æš«ç„¡æ•¸æ“š</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="monitor-section">
        <h2>æœ€è¿‘è¨˜éŒ„</h2>
        <div class="metrics-list" id="recentMetrics">
            <p class="no-data">æš«ç„¡è¨˜éŒ„</p>
        </div>
    </div>
</div>

<div class="monitor-actions">
    <button onclick="refreshMetrics()" class="btn btn-primary">
        ğŸ”„ åˆ·æ–°æ•¸æ“š
    </button>
    <button onclick="downloadReport()" class="btn btn-secondary">
        ğŸ“¥ ä¸‹è¼‰å ±å‘Š
    </button>
    <button onclick="clearMetrics()" class="btn btn-danger">
        ğŸ—‘ï¸ æ¸…é™¤æ•¸æ“š
    </button>
</div>
{% endblock %}

{% block extra_js %}
<script>
// åˆ·æ–°æ€§èƒ½æŒ‡æ¨™
async function refreshMetrics() {
    try {
        const response = await fetch('/api/monitor/metrics');
        const data = await response.json();

        // æ›´æ–°ç¸½é«”çµ±è¨ˆ
        const summary = data.summary;
        document.getElementById('total-metrics').textContent = summary.total_metrics;
        document.getElementById('total-duration').textContent = summary.total_duration.toFixed(2) + 's';
        document.getElementById('avg-cpu').textContent = summary.avg_cpu.toFixed(2) + '%';
        document.getElementById('success-rate').textContent = summary.success_rate.toFixed(2) + '%';

        // æ›´æ–°å‡½æ•¸çµ±è¨ˆè¡¨
        const statsTable = document.getElementById('functionsTable').querySelector('tbody');
        const stats = data.stats;

        if (Object.keys(stats).length === 0) {
            statsTable.innerHTML = '<tr><td colspan="6" class="no-data">æš«ç„¡æ•¸æ“š</td></tr>';
        } else {
            statsTable.innerHTML = Object.entries(stats)
                .sort((a, b) => b[1].total_time - a[1].total_time)
                .map(([name, stat]) => `
                    <tr>
                        <td>${name}</td>
                        <td>${stat.call_count}</td>
                        <td>${stat.total_time.toFixed(4)}s</td>
                        <td>${stat.avg_time.toFixed(4)}s</td>
                        <td>${stat.min_time.toFixed(4)}s</td>
                        <td>${stat.max_time.toFixed(4)}s</td>
                    </tr>
                `).join('');
        }

        // æ›´æ–°æœ€è¿‘è¨˜éŒ„
        const metricsDiv = document.getElementById('recentMetrics');
        const metrics = data.metrics;

        if (metrics.length === 0) {
            metricsDiv.innerHTML = '<p class="no-data">æš«ç„¡è¨˜éŒ„</p>';
        } else {
            metricsDiv.innerHTML = metrics.reverse().map(m => `
                <div class="metric-item ${m.success ? 'success' : 'failed'}">
                    <div class="metric-header">
                        <span class="metric-name">${m.function_name}</span>
                        <span class="metric-status">${m.success ? 'âœ…' : 'âŒ'}</span>
                    </div>
                    <div class="metric-details">
                        <span>â±ï¸ ${m.duration.toFixed(4)}s</span>
                        <span>ğŸ’¾ ${m.memory_delta_mb >= 0 ? '+' : ''}${m.memory_delta_mb.toFixed(2)}MB</span>
                        <span>ğŸ”¥ ${m.cpu_percent.toFixed(2)}%</span>
                    </div>
                    ${m.error_message ? `<div class="metric-error">${m.error_message}</div>` : ''}
                </div>
            `).join('');
        }

    } catch (error) {
        console.error('åˆ·æ–°æŒ‡æ¨™å¤±æ•—:', error);
        showNotification('âŒ åˆ·æ–°å¤±æ•—: ' + error.message, 'error');
    }
}

// ä¸‹è¼‰å ±å‘Š
async function downloadReport() {
    try {
        const response = await fetch('/api/monitor/report');
        const data = await response.json();

        const blob = new Blob([data.report], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `performance_report_${new Date().toISOString().split('T')[0]}.txt`;
        a.click();
        URL.revokeObjectURL(url);

        showNotification('âœ… å ±å‘Šå·²ä¸‹è¼‰', 'success');
    } catch (error) {
        showNotification('âŒ ä¸‹è¼‰å¤±æ•—: ' + error.message, 'error');
    }
}

// æ¸…é™¤æ•¸æ“šï¼ˆéœ€è¦å¾Œç«¯æ”¯æŒï¼‰
function clearMetrics() {
    if (!confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æ€§èƒ½æ•¸æ“šå—ï¼Ÿ')) {
        return;
    }

    showNotification('âš ï¸ æ­¤åŠŸèƒ½éœ€è¦å¾Œç«¯APIæ”¯æŒ', 'warning');
}

// é¡¯ç¤ºé€šçŸ¥
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.textContent = message;
    document.body.appendChild(notification);

    setTimeout(() => {
        notification.classList.add('show');
    }, 10);

    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// é é¢è¼‰å…¥æ™‚åˆ·æ–°
refreshMetrics();

// æ¯10ç§’è‡ªå‹•åˆ·æ–°
setInterval(refreshMetrics, 10000);
</script>
{% endblock %}
