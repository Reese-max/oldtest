{% extends "base.html" %}

{% block title %}ä¸Šå‚³è™•ç† - è€ƒå¤é¡Œè™•ç†ç³»çµ±{% endblock %}

{% block content %}
<h1>ğŸ“¤ PDFä¸Šå‚³èˆ‡è™•ç†</h1>

<div class="upload-section">
    <div class="upload-box">
        <input type="file" id="fileInput" accept=".pdf" style="display: none;" multiple>
        <button onclick="document.getElementById('fileInput').click()" class="btn btn-primary btn-lg">
            ğŸ“„ é¸æ“‡PDFæ–‡ä»¶
        </button>
        <p class="upload-hint">æ”¯æŒPDFæ ¼å¼ï¼Œæœ€å¤§50MBï¼Œå¯æ‰¹é‡ä¸Šå‚³</p>
    </div>

    <div id="uploadProgress" class="upload-progress" style="display: none;">
        <div class="progress-bar">
            <div id="progressFill" class="progress-fill"></div>
        </div>
        <p id="progressText">ä¸Šå‚³ä¸­...</p>
    </div>
</div>

<div class="tasks-section">
    <h2>è™•ç†ä»»å‹™åˆ—è¡¨</h2>
    <div class="tasks-toolbar">
        <button onclick="refreshTasks()" class="btn btn-secondary">
            ğŸ”„ åˆ·æ–°åˆ—è¡¨
        </button>
        <button onclick="clearCompleted()" class="btn btn-secondary">
            ğŸ—‘ï¸ æ¸…é™¤å·²å®Œæˆ
        </button>
    </div>

    <div id="tasksList" class="tasks-list">
        <p class="no-tasks">æš«ç„¡ä»»å‹™</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let selectedFiles = [];

// æ–‡ä»¶é¸æ“‡è™•ç†
document.getElementById('fileInput').addEventListener('change', function(e) {
    selectedFiles = Array.from(e.target.files);
    if (selectedFiles.length > 0) {
        uploadFiles(selectedFiles);
    }
});

// ä¸Šå‚³æ–‡ä»¶
async function uploadFiles(files) {
    const progressDiv = document.getElementById('uploadProgress');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');

    progressDiv.style.display = 'block';

    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const formData = new FormData();
        formData.append('file', file);

        progressText.textContent = `ä¸Šå‚³ ${i + 1}/${files.length}: ${file.name}`;
        progressFill.style.width = `${(i / files.length) * 100}%`;

        try {
            const response = await fetch('/api/upload', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (result.success) {
                showNotification(`âœ… ${result.filename} ä¸Šå‚³æˆåŠŸ`, 'success');
            } else {
                showNotification(`âŒ ${file.name} ä¸Šå‚³å¤±æ•—: ${result.error}`, 'error');
            }
        } catch (error) {
            showNotification(`âŒ ${file.name} ä¸Šå‚³å¤±æ•—: ${error.message}`, 'error');
        }
    }

    progressFill.style.width = '100%';
    progressText.textContent = `å®Œæˆä¸Šå‚³ ${files.length} å€‹æ–‡ä»¶`;

    setTimeout(() => {
        progressDiv.style.display = 'none';
        refreshTasks();
    }, 2000);
}

// è™•ç†ä»»å‹™
async function processTask(taskId) {
    try {
        const response = await fetch(`/api/process/${taskId}`, {
            method: 'POST'
        });

        const result = await response.json();

        if (result.success) {
            showNotification(`âœ… ${result.message}`, 'success');
            refreshTasks();
        } else {
            showNotification(`âŒ è™•ç†å¤±æ•—: ${result.error}`, 'error');
        }
    } catch (error) {
        showNotification(`âŒ è™•ç†å¤±æ•—: ${error.message}`, 'error');
    }
}

// ä¸‹è¼‰æ–‡ä»¶
function downloadFile(taskId, fileType) {
    window.location.href = `/api/download/${taskId}/${fileType}`;
}

// åˆªé™¤ä»»å‹™
async function deleteTask(taskId) {
    if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ä»»å‹™å—ï¼Ÿ')) {
        return;
    }

    try {
        const response = await fetch(`/api/delete/${taskId}`, {
            method: 'DELETE'
        });

        const result = await response.json();

        if (result.success) {
            showNotification('âœ… ä»»å‹™å·²åˆªé™¤', 'success');
            refreshTasks();
        } else {
            showNotification(`âŒ åˆªé™¤å¤±æ•—: ${result.error}`, 'error');
        }
    } catch (error) {
        showNotification(`âŒ åˆªé™¤å¤±æ•—: ${error.message}`, 'error');
    }
}

// åˆ·æ–°ä»»å‹™åˆ—è¡¨
async function refreshTasks() {
    try {
        const response = await fetch('/api/tasks');
        const tasks = await response.json();

        const tasksList = document.getElementById('tasksList');

        if (tasks.length === 0) {
            tasksList.innerHTML = '<p class="no-tasks">æš«ç„¡ä»»å‹™</p>';
            return;
        }

        tasksList.innerHTML = tasks.map(task => `
            <div class="task-card ${task.status}">
                <div class="task-header">
                    <h3>${task.filename}</h3>
                    <span class="task-status status-${task.status}">${getStatusText(task.status)}</span>
                </div>
                <div class="task-info">
                    <span>ğŸ“… ${new Date(task.created_at).toLocaleString()}</span>
                    ${task.result ? `<span>ğŸ“ ${task.result.question_count} é¡Œ</span>` : ''}
                </div>
                <div class="task-actions">
                    ${task.status === 'uploaded' ? `
                        <button onclick="processTask('${task.id}')" class="btn btn-primary btn-sm">
                            â–¶ï¸ é–‹å§‹è™•ç†
                        </button>
                    ` : ''}
                    ${task.status === 'completed' ? `
                        <button onclick="downloadFile('${task.id}', 'csv')" class="btn btn-success btn-sm">
                            ğŸ“¥ ä¸‹è¼‰CSV
                        </button>
                        ${task.result.script_path ? `
                            <button onclick="downloadFile('${task.id}', 'script')" class="btn btn-success btn-sm">
                                ğŸ“¥ ä¸‹è¼‰è…³æœ¬
                            </button>
                        ` : ''}
                    ` : ''}
                    <button onclick="deleteTask('${task.id}')" class="btn btn-danger btn-sm">
                        ğŸ—‘ï¸ åˆªé™¤
                    </button>
                </div>
                ${task.status === 'processing' ? `
                    <div class="task-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${task.progress}%"></div>
                        </div>
                    </div>
                ` : ''}
                ${task.error ? `
                    <div class="task-error">âŒ ${task.error}</div>
                ` : ''}
            </div>
        `).join('');
    } catch (error) {
        console.error('åˆ·æ–°ä»»å‹™å¤±æ•—:', error);
    }
}

// æ¸…é™¤å·²å®Œæˆä»»å‹™
async function clearCompleted() {
    if (!confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å·²å®Œæˆçš„ä»»å‹™å—ï¼Ÿ')) {
        return;
    }

    try {
        const response = await fetch('/api/tasks');
        const tasks = await response.json();

        const completedTasks = tasks.filter(t => t.status === 'completed');

        for (const task of completedTasks) {
            await fetch(`/api/delete/${task.id}`, { method: 'DELETE' });
        }

        showNotification(`âœ… å·²æ¸…é™¤ ${completedTasks.length} å€‹ä»»å‹™`, 'success');
        refreshTasks();
    } catch (error) {
        showNotification(`âŒ æ¸…é™¤å¤±æ•—: ${error.message}`, 'error');
    }
}

// ç²å–ç‹€æ…‹æ–‡æœ¬
function getStatusText(status) {
    const statusMap = {
        'uploaded': 'å·²ä¸Šå‚³',
        'processing': 'è™•ç†ä¸­',
        'completed': 'å·²å®Œæˆ',
        'failed': 'å¤±æ•—'
    };
    return statusMap[status] || status;
}

// é¡¯ç¤ºé€šçŸ¥
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.textContent = message;
    document.body.appendChild(notification);

    setTimeout(() => {
        notification.classList.add('show');
    }, 10);

    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// é é¢è¼‰å…¥æ™‚åˆ·æ–°ä»»å‹™
refreshTasks();

// æ¯5ç§’è‡ªå‹•åˆ·æ–°
setInterval(refreshTasks, 5000);
</script>
{% endblock %}
