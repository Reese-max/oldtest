# 完整問題修復任務清單

**基於**: ISSUES_INVENTORY_AND_FIX_PLAN.md
**創建日期**: 2025-11-16
**總問題數**: 62 個（已修復 3 個，待修復 59 個）

---

## 🔥 第一優先級：嚴重問題修復（本週內完成）

### ✅ 已完成 (3/12)

- [x] **S1. 空列表索引訪問風險**
  - 檔案: `src/core/no_label_question_parser.py`
  - 狀態: ✅ 已修復
  - 工作量: 15 分鐘

- [x] **S2. Unicode 字符處理錯誤**
  - 檔案: `src/core/pdf_processor.py`
  - 狀態: ✅ 已修復
  - 工作量: 20 分鐘

- [x] **S3. 正則表達式未預編譯**
  - 檔案: `src/utils/regex_patterns.py`
  - 狀態: ✅ 確認已預編譯
  - 工作量: 0 分鐘

### ⏳ 待執行 (9/12)

#### 任務 1: 修復大文件記憶體管理
- **編號**: S4
- **優先級**: ⭐⭐⭐⭐⭐ (立即)
- **檔案**: `src/core/pdf_processor.py`
- **問題**: 大型 PDF 文件（>100 頁）可能導致記憶體溢出
- **修復內容**:
  - [ ] 添加 `max_pages` 參數（預設 200）
  - [ ] 實現分批處理（每 50 頁觸發 gc.collect()）
  - [ ] 添加大文件警告日誌
  - [ ] 更新函數簽名和文檔
- **預計工作量**: 45 分鐘
- **驗證方法**: 測試處理 500+ 頁的 PDF

#### 任務 2: 完善 CSV 錯誤處理
- **編號**: S5
- **優先級**: ⭐⭐⭐⭐ (本週內)
- **檔案**: `src/core/csv_generator.py`
- **問題**: CSV 生成過程中缺少對 pandas 異常的處理
- **修復內容**:
  - [ ] 添加 `pandas.errors.EmptyDataError` 處理
  - [ ] 添加 `IOError/OSError` 處理
  - [ ] 添加必要欄位驗證
  - [ ] 改進空 CSV 生成邏輯
  - [ ] 更新單元測試
- **預計工作量**: 30 分鐘
- **驗證方法**: 運行 `test_unit.py` 中的 CSV 測試

#### 任務 3: 重構長函數
- **編號**: S6
- **優先級**: ⭐⭐⭐ (2 週內)
- **檔案**: `src/processors/archaeology_processor.py`
- **問題**: `process_archaeology_pdfs` 函數長達 102 行
- **修復內容**:
  - [ ] 創建 `_validate_inputs()` 方法
  - [ ] 創建 `_extract_all_texts()` 方法
  - [ ] 創建 `_extract_all_answers()` 方法
  - [ ] 創建 `_parse_questions()` 方法
  - [ ] 創建 `_merge_answers()` 方法
  - [ ] 創建 `_generate_outputs()` 方法
  - [ ] 重構主函數為協調器
- **預計工作量**: 2 小時
- **驗證方法**: 運行完整的功能測試

#### 任務 4: 添加配置熱重載
- **編號**: S7
- **優先級**: ⭐⭐ (可選)
- **檔案**: `src/utils/config.py`
- **問題**: 配置文件修改後需要重啟程序
- **修復內容**:
  - [ ] 添加 `_last_modified` 追蹤
  - [ ] 實現 `_should_reload()` 方法
  - [ ] 修改 `load_config()` 支持自動重載
  - [ ] 添加重載日誌
- **預計工作量**: 1 小時
- **驗證方法**: 修改 config.json 並測試自動重載

#### 任務 5: 修復測試失敗
- **編號**: S8
- **優先級**: ⭐⭐⭐⭐ (本週內)
- **檔案**: `test_unit.py`
- **問題**: 6 個單元測試失敗（主要是 Google Script Generator）
- **修復內容**:
  - [ ] 檢查 `GoogleScriptGenerator` 的實際 API
  - [ ] 更新測試方法名稱匹配實際實現
  - [ ] 修復 CSV 空數據測試
  - [ ] 修復屬性訪問錯誤
  - [ ] 避免測試私有方法
  - [ ] 運行並驗證所有測試通過
- **預計工作量**: 1 小時
- **驗證方法**: `python test_unit.py` 通過率 > 95%

#### 任務 6: 增強日誌記錄
- **編號**: S9
- **優先級**: ⭐⭐⭐ (2 週內)
- **檔案**: 多個核心模組
- **問題**: 部分關鍵操作缺少日誌記錄
- **修復內容**:
  - [ ] `answer_processor.py` - 添加詳細提取日誌
  - [ ] `pdf_processor.py` - 添加處理進度日誌
  - [ ] `csv_generator.py` - 添加生成步驟日誌
  - [ ] 統一日誌格式和級別
  - [ ] 添加調試模式支持
- **預計工作量**: 2 小時
- **驗證方法**: 運行測試並檢查日誌輸出

#### 任務 7: 添加輸入驗證
- **編號**: S10
- **優先級**: ⭐⭐⭐⭐ (本週內)
- **檔案**: 多個核心模組
- **問題**: 公共方法缺少輸入參數驗證
- **修復內容**:
  - [ ] `csv_generator.py` - 驗證 questions, answers, output_path
  - [ ] `google_script_generator.py` - 驗證輸入參數
  - [ ] `pdf_processor.py` - 驗證文件路徑
  - [ ] 添加類型檢查
  - [ ] 添加值範圍檢查
  - [ ] 自動創建輸出目錄
- **預計工作量**: 1.5 小時
- **驗證方法**: 測試邊緣情況和無效輸入

#### 任務 8: 修復並發安全問題
- **編號**: S11
- **優先級**: ⭐⭐⭐⭐ (本週內)
- **檔案**: `src/utils/config.py`, `src/utils/logger.py`
- **問題**: 單例模式實現不是線程安全的
- **修復內容**:
  - [ ] 添加 `threading.Lock`
  - [ ] 實現雙重檢查鎖定
  - [ ] 添加 `_initialized` 標記
  - [ ] 確保只初始化一次
  - [ ] 添加並發測試
- **預計工作量**: 45 分鐘
- **驗證方法**: 運行並發測試驗證線程安全

#### 任務 9: 修復臨時文件安全問題
- **編號**: S12
- **優先級**: ⭐⭐⭐ (2 週內)
- **檔案**: 測試文件和核心模組
- **問題**: 使用已棄用的 `tempfile.mktemp()`
- **修復內容**:
  - [ ] 搜索所有 `tempfile.mktemp()` 使用
  - [ ] 替換為 `tempfile.NamedTemporaryFile()`
  - [ ] 或使用 `tempfile.mkstemp()`
  - [ ] 確保正確清理
  - [ ] 更新測試文件
- **預計工作量**: 30 分鐘
- **驗證方法**: 檢查沒有安全警告

---

## 🟡 第二優先級：中等問題修復（2 週內完成）

### 任務 10: 消除代碼重複
- **編號**: M1
- **優先級**: ⭐⭐⭐
- **檔案**: 多個生成器文件
- **問題**: CSV 欄位名稱在多處重複定義
- **修復內容**:
  - [ ] 統一使用 `constants.py` 中的定義
  - [ ] 移除重複的欄位定義
  - [ ] 添加導入檢查
- **預計工作量**: 30 分鐘

### 任務 11: 消除魔法數字
- **編號**: M2
- **優先級**: ⭐⭐
- **檔案**: `src/core/pdf_processor.py`
- **問題**: 硬編碼的數字（如 300, 2.0）缺少說明
- **修復內容**:
  - [ ] 定義常量 `DEFAULT_DPI = 300`
  - [ ] 定義常量 `DEFAULT_ZOOM = 2.0`
  - [ ] 添加常量註釋
  - [ ] 替換所有硬編碼數字
- **預計工作量**: 20 分鐘

### 任務 12: 重構長參數列表
- **編號**: M3
- **優先級**: ⭐⭐⭐
- **檔案**: `src/processors/archaeology_processor.py`
- **問題**: 某些函數有 6+ 個參數
- **修復內容**:
  - [ ] 創建配置字典或參數對象
  - [ ] 重構 `process_archaeology_pdfs` 方法
  - [ ] 使用 `@dataclass` 定義參數類
  - [ ] 更新調用處
- **預計工作量**: 1 小時

### 任務 13: 添加類型提示
- **編號**: M4
- **優先級**: ⭐⭐
- **檔案**: 多個文件
- **問題**: 部分函數缺少完整的類型提示
- **修復內容**:
  - [ ] 檢查所有公共方法
  - [ ] 添加參數類型提示
  - [ ] 添加返回值類型提示
  - [ ] 使用 `Optional`, `List`, `Dict` 等
  - [ ] 運行 mypy 檢查
- **預計工作量**: 2 小時

### 任務 14: 移動局部導入到頂部
- **編號**: M5
- **優先級**: ⭐⭐
- **檔案**: `src/processors/archaeology_processor.py`
- **問題**: 在函數內部導入常量
- **修復內容**:
  - [ ] 識別所有局部導入
  - [ ] 移至文件頂部
  - [ ] 按照 PEP 8 排序
- **預計工作量**: 10 分鐘

### 任務 15: 統一返回值類型
- **編號**: M6
- **優先級**: ⭐⭐⭐
- **檔案**: `src/core/pdf_structure_analyzer.py`
- **問題**: 返回值類型不一致（枚舉 vs 字符串）
- **修復內容**:
  - [ ] 統一使用枚舉類型
  - [ ] 更新所有調用處
  - [ ] 添加類型轉換方法
- **預計工作量**: 45 分鐘

### 任務 16: 優化異常處理
- **編號**: M7
- **優先級**: ⭐⭐⭐
- **檔案**: 多個文件
- **問題**: 使用過於寬泛的 `except Exception`
- **修復內容**:
  - [ ] 識別所有寬泛異常捕獲
  - [ ] 替換為特定異常類型
  - [ ] 添加適當的異常處理
  - [ ] 保留必要的寬泛捕獲並添加註釋
- **預計工作量**: 1 小時

### 任務 17: 補充文檔字符串
- **編號**: M8
- **優先級**: ⭐⭐
- **檔案**: 多個文件
- **問題**: 部分函數缺少 docstring
- **修復內容**:
  - [ ] 檢查所有公共方法
  - [ ] 添加詳細的文檔字符串
  - [ ] 包含 Args, Returns, Raises
  - [ ] 添加使用示例
- **預計工作量**: 3 小時

### 任務 18: 移除硬編碼路徑
- **編號**: M9
- **優先級**: ⭐⭐⭐
- **檔案**: 測試文件
- **問題**: 使用硬編碼的文件路徑
- **修復內容**:
  - [ ] 使用 `os.path.join`
  - [ ] 使用相對路徑
  - [ ] 使用環境變量
  - [ ] 添加路徑配置
- **預計工作量**: 30 分鐘

### 任務 19: 補充單元測試
- **編號**: M10
- **優先級**: ⭐⭐⭐⭐
- **檔案**: 測試文件
- **問題**: 部分核心功能缺少單元測試
- **修復內容**:
  - [ ] OCR 處理器測試
  - [ ] 題目解析器測試
  - [ ] 答案合併邏輯測試
  - [ ] 邊緣情況測試
  - [ ] 達到 90% 覆蓋率
- **預計工作量**: 4 小時

---

## 🟢 第三優先級：輕微問題修復（長期計劃）

### 任務 20: 代碼風格統一
- **編號**: L1-L19
- **優先級**: ⭐
- **檔案**: 所有 Python 文件
- **問題**: 代碼風格不一致（19 個問題）
- **修復內容**:
  - [ ] 使用 `black` 自動格式化
  - [ ] 使用 `isort` 排序導入
  - [ ] 使用 `flake8` 檢查
  - [ ] 統一變量命名
  - [ ] 統一註釋語言
  - [ ] 修復行長度問題
  - [ ] 規範空行使用
- **預計工作量**: 1 小時（使用自動化工具）

---

## 📊 任務統計

### 按優先級

| 優先級 | 任務數 | 預計工作量 | 狀態 |
|--------|--------|-----------|------|
| 🔥 第一優先級（嚴重） | 12 | 8.5 小時 | 3/12 完成 |
| 🟡 第二優先級（中等） | 10 | 13.5 小時 | 0/10 完成 |
| 🟢 第三優先級（輕微） | 1 組 | 1 小時 | 0/1 完成 |
| **總計** | **23 項** | **23 小時** | **13%** |

### 按時間計劃

**本週內（立即執行）**:
- 任務 1: S4 大文件處理 (45 分鐘)
- 任務 2: S5 CSV 錯誤處理 (30 分鐘)
- 任務 5: S8 測試修復 (1 小時)
- 任務 7: S10 輸入驗證 (1.5 小時)
- 任務 8: S11 並發安全 (45 分鐘)
- **小計**: 4.5 小時

**2 週內**:
- 任務 3: S6 長函數重構 (2 小時)
- 任務 4: S7 配置熱重載 (1 小時)
- 任務 6: S9 日誌增強 (2 小時)
- 任務 9: S12 臨時文件 (30 分鐘)
- 任務 10-19: M1-M10 中等問題 (13.5 小時)
- **小計**: 19 小時

**長期**:
- 任務 20: L1-L19 代碼風格 (1 小時)

---

## 🎯 執行建議

### 第 1 天（今日）
- ✅ 完成任務規劃
- ⏳ 開始任務 2（S5）和任務 5（S8）
- 預計完成: 2 個任務

### 第 2-3 天
- 任務 1（S4）
- 任務 7（S10）
- 任務 8（S11）
- 預計完成: 3 個任務

### 第 4-5 天
- 任務 9（S12）
- 任務 10-12（M1-M3）
- 預計完成: 4 個任務

### 第 2 週
- 任務 3（S6）
- 任務 4（S7）
- 任務 6（S9）
- 任務 13-19（M4-M10）
- 預計完成: 10 個任務

### 長期
- 任務 20（L1-L19）
- 代碼審查和優化

---

## ✅ 完成標準

每個任務完成後需要：

1. **代碼修改**：按照修復內容完成代碼變更
2. **單元測試**：添加或更新相關測試
3. **驗證測試**：運行測試確保通過
4. **代碼審查**：自我審查代碼質量
5. **文檔更新**：更新相關文檔
6. **提交代碼**：使用清晰的提交信息

---

## 📈 進度追蹤

使用此格式追蹤進度：

```
[x] 任務 1: S4 大文件處理
    - 修改時間: 2025-11-16 15:30
    - 測試結果: ✅ 通過
    - 提交哈希: abc1234

[ ] 任務 2: S5 CSV 錯誤處理
    - 狀態: 進行中
    - 完成度: 60%
```

---

**創建人**: Claude AI
**最後更新**: 2025-11-16
**狀態**: 📋 待執行
**下一步**: 執行本週內的 5 個高優先級任務
